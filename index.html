<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V28 è¨ºæ–·å¤§å¸«ç‰ˆ</title>
    <style>
        body { font-family: monospace; background: #121212; color: #00e5ff; padding: 20px; line-height: 1.6; }
        h2 { color: #fff; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .log-box { background: #222; border: 1px solid #444; padding: 15px; border-radius: 5px; min-height: 300px; white-space: pre-wrap; font-size: 14px; }
        .success { color: #4caf50; }
        .error { color: #ff5252; font-weight: bold; }
        .warning { color: #ffeb3b; }
        button { background: #333; color: white; border: 1px solid #555; padding: 10px 20px; margin-top: 10px; cursor: pointer; font-size: 16px; }
        button:hover { background: #444; }
    </style>
</head>
<body>

<h2>ğŸ•µï¸â€â™‚ï¸ V28 ç³»çµ±è‡ªæˆ‘è¨ºæ–·</h2>
<p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç³»çµ±å°‡ç›´æ¥æ¸¬è©¦æª”æ¡ˆé€£ç·šç‹€æ³ã€‚</p>
<button onclick="startDiagnosis()">ğŸš€ é–‹å§‹è¨ºæ–·</button>
<div id="logs" class="log-box">ç­‰å¾…é–‹å§‹...</div>

<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.1';
    
    // è¨­å®šç’°å¢ƒ
    env.allowLocalModels = false;
    env.allowRemoteModels = true;
    env.useBrowserCache = false;

    window.logger = function(msg, type='normal') {
        const box = document.getElementById('logs');
        let color = '#00e5ff';
        if(type === 'error') color = '#ff5252';
        if(type === 'success') color = '#4caf50';
        if(type === 'warning') color = '#ffeb3b';
        
        box.innerHTML += `<span style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</span>\n`;
    }

    // å–å¾—çµ•å°è·¯å¾‘
    function getBasePath() {
        let path = window.location.href;
        if (path.endsWith('index.html')) path = path.substring(0, path.length - 'index.html'.length);
        if (!path.endsWith('/')) path += '/';
        return path + 'model/';
    }

    window.startDiagnosis = async function() {
        const box = document.getElementById('logs');
        box.innerHTML = "=== é–‹å§‹è¨ºæ–· ===\n";
        
        const basePath = getBasePath();
        logger(`1. åµæ¸¬åŸºç¤è·¯å¾‘: ${basePath}`);

        // æ¸¬è©¦æª”æ¡ˆåˆ—è¡¨
        const files = ['config.json', 'preprocessor_config.json', 'model.onnx'];
        let allSuccess = true;

        for (const file of files) {
            const url = basePath + file;
            logger(`æ­£åœ¨æª¢æŸ¥: ${file}...`);
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    const sizeMB = size ? (parseInt(size) / 1024 / 1024).toFixed(2) : "æœªçŸ¥";
                    
                    logger(`âœ… ${file} è®€å–æˆåŠŸ (HTTP ${response.status})`, 'success');
                    logger(`   - å¤§å°: ${sizeMB} MB`);

                    // æª¢æŸ¥æ˜¯å¦ç‚º LFS æŒ‡æ¨™æª” (å¦‚æœ model.onnx å°æ–¼ 1KB å°±æ˜¯å‡çš„)
                    if (file === 'model.onnx' && size && parseInt(size) < 2000) {
                        logger(`âŒ åš´é‡éŒ¯èª¤ï¼šmodel.onnx åªæœ‰ ${size} bytesï¼`, 'error');
                        logger(`   é€™ä»£è¡¨æ‚¨ä½¿ç”¨äº† Git LFSï¼Œä½† GitHub Pages ä¸æ”¯æ´ã€‚`, 'warning');
                        logger(`   è«‹é‡æ–°ä¸Šå‚³ã€Œæ™®é€šæª”æ¡ˆã€ç‰ˆæœ¬çš„ model.onnxã€‚`, 'warning');
                        allSuccess = false;
                    }
                } else {
                    logger(`âŒ ${file} å¤±æ•— (HTTP ${response.status})`, 'error');
                    logger(`   è«‹ç¢ºèª GitHub ä¸Š 'model' è³‡æ–™å¤¾å…§æ˜¯å¦æœ‰æ­¤æª”æ¡ˆ`, 'error');
                    allSuccess = false;
                }
            } catch (err) {
                logger(`âŒ ${file} é€£ç·šéŒ¯èª¤: ${err.message}`, 'error');
                allSuccess = false;
            }
        }

        if (allSuccess) {
            logger("\n=== æª”æ¡ˆæª¢æŸ¥é€šéï¼Œå˜—è©¦è¼‰å…¥ AI ===", 'success');
            try {
                const segmenter = await pipeline('image-segmentation', basePath, {
                    quantized: false, // å¼·åˆ¶è®€å– model.onnx
                    progress_callback: (data) => {
                        if(data.status === 'initiate') logger(`æ­£åœ¨ä¸‹è¼‰: ${data.file} ...`);
                    }
                });
                logger("ğŸ‰ğŸ‰ğŸ‰ AI è¼‰å…¥æˆåŠŸï¼æ­å–œï¼", 'success');
                logger("ç¾åœ¨æ‚¨å¯ä»¥æ”¾å¿ƒæŠŠç¨‹å¼ç¢¼æ›å› V27 äº†ã€‚", 'success');
            } catch (e) {
                logger(`âŒ AI å¼•æ“åˆå§‹åŒ–å¤±æ•—: ${e.message}`, 'error');
            }
        } else {
            logger("\nâš ï¸ è¨ºæ–·çµæŸï¼šè«‹æ ¹æ“šä¸Šæ–¹ç´…å­—éŒ¯èª¤ä¿®å¾©æ‚¨çš„ GitHub æª”æ¡ˆã€‚", 'warning');
        }
    }
</script>
</body>
</html>
